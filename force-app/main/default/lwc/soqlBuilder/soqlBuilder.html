<template>
  <div class="slds-grid slds-wrap slds-gutters builder-layout">
    <!-- LEFT: Builder Controls -->
    <div class="slds-col slds-size_1-of-1 slds-large-size_2-of-3">
      <lightning-card
        title="SOQL Builder"
        icon-name="custom:custom63"
        class="soql-card"
      >
        <div class="slds-card__body builder-wrapper slds-p-around_large">
          <template if:true={objectOptions.length}>
            <div class="section-card">
              <!-- Toggle for advanced object visibility -->
              <div class="slds-m-bottom_medium">
                <lightning-input
                  type="checkbox"
                  label="Include Non-Object Types"
                  checked={includeNonObjects}
                  onchange={handleToggleInclude}
                ></lightning-input>
              </div>

              <!-- Object Picker -->

              <h2 class="section-header">Object Selector</h2>
              <lightning-combobox
                value={selectedObject}
                options={objectOptions}
                onchange={handleObjectChange}
              ></lightning-combobox>
            </div>
          </template>
          <template if:true={dualListBoxReady}>
            <div class="section-card">
              <!-- Field Selector -->
              <h2 class="section-header">Field Selector</h2>
              <lightning-input
                type="search"
                placeholder="Search fields…"
                data-list-type="main"
                onchange={handleOptionsSearch}
                class="slds-m-bottom_x-small"
              ></lightning-input>

              <lightning-dual-listbox
                name="fieldSelector"
                source-label="Available"
                selected-label="Selected"
                options={filteredFieldOptions}
                value={selectedFields}
                onchange={handleFieldSelection}
              ></lightning-dual-listbox>
            </div>
          </template>

          <template if:true={shouldShowParentSection}>
            <div class="section-card">
              <!-- Parent Selector -->
              <template if:true={hasParentOptions}>
                <h2 class="section-header">Parent Selector</h2>
                <lightning-combobox
                  value={selectedParent}
                  options={filteredParentRelOptions}
                  onchange={handleParentSelect}
                  placeholder="Select a parent relationship"
                ></lightning-combobox>
              </template>

              <!-- Parent Field Selector -->
              <template if:true={selectedParent}>
                <lightning-dual-listbox
                  name="parentFields"
                  source-label="Available"
                  selected-label="Selected"
                  options={filteredParentFieldOptions}
                  value={selectedParentFields}
                  onchange={handleParentFieldChange}
                ></lightning-dual-listbox>
              </template>
            </div>
          </template>
          <template if:true={selectedObject}>
            <div class="section-card">
              <!-- Child Relationships -->

              <h2 class="section-header">Child Selector</h2>
              <lightning-dual-listbox
                name="relatedLists"
                source-label="Available"
                selected-label="Included"
                options={childRelationships}
                value={selectedRelationships}
                onchange={handleRelationshipSelection}
              ></lightning-dual-listbox>

              <!-- Child Field Selectors -->
              <template if:true={childFieldConfigs}>
                <lightning-accordion
                  class="child-section"
                  allow-multiple-sections-open
                  active-section-name={openChildSections}
                >
                  <template for:each={childFieldConfigs} for:item="cfg">
                    <lightning-accordion-section
                      key={cfg.rel}
                      name={cfg.rel}
                      label={cfg.label}
                    >
                      <lightning-input
                        type="search"
                        data-list-type="child"
                        data-options-key={cfg.rel}
                        placeholder="Search fields…"
                        onchange={handleOptionsSearch}
                        class="slds-m-bottom_x-small"
                      ></lightning-input>
                      <lightning-dual-listbox
                        name={cfg.rel}
                        source-label="Available"
                        selected-label="Selected"
                        options={cfg.options}
                        value={cfg.selected}
                        onchange={handleChildFieldSelection}
                      ></lightning-dual-listbox>
                    </lightning-accordion-section>
                  </template>
                </lightning-accordion>
              </template>
            </div>
          </template>
          <!-- WHERE Clause Builder -->
          <template if:true={showFieldSelector}>
            <div class="section-card">
              <div class="slds-m-top_medium">
                <h2 class="section-header">WHERE Clause</h2>
                <div
                  class="slds-grid slds-grid_align-spread slds-m-bottom_small"
                >
                  <lightning-button-icon
                    icon-name={whereToggleIcon}
                    alternative-text="Toggle Advanced Mode"
                    title="Toggle WHERE Clause Mode"
                    onclick={toggleWhereMode}
                  ></lightning-button-icon>
                </div>

                <!-- Visual Filters -->
                <template if:false={useAdvancedMode}>
                  <template
                    for:each={filtersWithOperatorOptions}
                    for:item="filter"
                  >
                    <div key={filter.id} class="filter-row">
                      <div>
                        <lightning-combobox
                          label="Field"
                          name="field"
                          data-index={filter.index}
                          value={filter.field}
                          options={fieldOptions}
                          onchange={handleFilterChange}
                        ></lightning-combobox>
                      </div>
                      <div>
                        <lightning-combobox
                          label="Operator"
                          name="operator"
                          data-index={filter.index}
                          value={filter.operator}
                          options={filter.safeOperators}
                          disabled={filter.isDisabled}
                          onchange={handleFilterChange}
                        ></lightning-combobox>
                      </div>
                      <div>
                        <lightning-input
                          label="Value"
                          name="value"
                          data-index={filter.index}
                          value={filter.value}
                          onchange={handleFilterChange}
                        ></lightning-input>
                      </div>
                      <div class="slds-align-bottom">
                        <lightning-button-icon
                          icon-name="utility:close"
                          alternative-text="Remove Filter"
                          title="Remove Filter"
                          data-index={filter.index}
                          onclick={handleRemoveFilter}
                        ></lightning-button-icon>
                      </div>
                    </div>
                  </template>

                  <div class="slds-m-top_small slds-m-bottom_medium">
                    <lightning-button
                      label="Add Filter"
                      icon-name="utility:add"
                      onclick={addFilter}
                    ></lightning-button>
                  </div>
                </template>

                <!-- Advanced WHERE Textarea -->
                <template if:true={useAdvancedMode}>
                  <lightning-textarea
                    label="Manual WHERE Clause"
                    value={rawWhereClause}
                    onchange={handleWhereInputChange}
                    placeholder="e.g. Status = 'Open' AND CreatedDate > LAST_N_DAYS:30"
                    class="slds-m-top_small"
                  ></lightning-textarea>
                </template>
              </div>
              <!-- SOQL Builder Controls -->
              <c-soql-builder-controls
                oncontrolsupdate={handleControlsUpdate}
              ></c-soql-builder-controls>
            </div>
          </template>
        </div>
      </lightning-card>
    </div>
    <!-- RIGHT: Query Preview & Results Panel -->

    <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
      <div
        class="slds-box slds-theme_default slds-p-around_medium query-panel-wrapper"
      >
        <div class="sticky">
          <div class="query-panel">
            <!-- Build Button -->
            <lightning-button
              label="Run Query"
              title="Run SOQL Query"
              onclick={handleBuildQuery}
              class="action-button"
            ></lightning-button>

            <!-- SOQL Preview -->
            <template if:true={soqlPreview}>
              <lightning-card title="SOQL Preview" class="slds-m-bottom_medium">
                <pre class="soql-preview">{soqlPreview}</pre>
              </lightning-card>
            </template>

            <!-- Placeholder -->
            <template if:false={soqlPreview}>
              <template if:false={queryResults}>
                <p class="soql-placeholder slds-m-top_medium">
                  👋 Select an object and fields to begin building your query…
                </p>
              </template>
            </template>

            <!-- Results Table -->
            <template if:true={queryResults}>
              <lightning-card title="Query Results" class="slds-m-top_medium">
                <div class="scrollable-table-container">
                  <lightning-datatable
                    key-field="Id"
                    data={visibleResults}
                    columns={tableColumns}
                  ></lightning-datatable>
                </div>

                <!-- Export Notice -->
                <template if:true={showExportNotice}>
                  <div
                    class="slds-notify slds-notify_alert slds-theme_info slds-m-top_small"
                    role="alert"
                  >
                    <lightning-icon
                      icon-name="utility:info"
                      alternative-text="Info"
                      size="x-small"
                      class="slds-m-right_x-small"
                    ></lightning-icon>
                    <span>
                      Showing only the first 50 rows. For the full dataset,
                      click
                      <strong>Email CSV</strong>.
                    </span>
                  </div>
                </template>

                <!-- Export Button -->
                <lightning-button
                  label="Email CSV Results"
                  onclick={handleExport}
                  variant="brand"
                  class="action-button"
                ></lightning-button>
              </lightning-card>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
