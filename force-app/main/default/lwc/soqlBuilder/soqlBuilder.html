<template>
  <div class="builder-wrapper slds-p-around_medium">
    <lightning-card title="SOQL Builder">
      <div class="slds-card__body">

        <!-- Toggle for advanced object visibility -->
        <div class="slds-m-bottom_medium">
          <lightning-input
            type="checkbox"
            label="Include Non-Object Types"
            checked={includeNonObjects}
            onchange={handleToggleInclude}
          ></lightning-input>
        </div>

        <!-- Object Picker -->
         <template if:true={objectOptions.length}></template>
        <template if:true={objectOptions.length}>
          <lightning-combobox
            label="Select Object"
            value={selectedObject}
            options={objectOptions}
            onchange={handleObjectChange}
            class="slds-m-bottom_large"
          ></lightning-combobox>
        </template>

        <!-- Field Selector -->
        <template if:true={dualListBoxReady}>
          <!-- Search -->
          <lightning-input
            type="search"
            placeholder="Search fields…"
            data-list-type="main"
            onchange={handleOptionsSearch}
            class="slds-m-bottom_x-small"
          ></lightning-input>
          <!-- Dual Listbox -->
          <lightning-dual-listbox
            name="fieldSelector"
            label="Select Fields"
            source-label="Available"
            selected-label="Selected"
            options={filteredFieldOptions}
            value={selectedFields}
            onchange={handleFieldSelection}
            class="slds-m-bottom_large"
          ></lightning-dual-listbox>
        </template>

        <!-- Parent Selector -->
        <template if:true={hasParentOptions}>
          <!-- Search -->
          <lightning-input
            type="search"
            placeholder="Search relationships…"
            data-list-type="parentRel"
            onchange={handleOptionsSearch}
            class="slds-m-bottom_x-small"
          ></lightning-input>
          <!-- Combobox -->
          <lightning-combobox
            label="Parent Relationship"
            value={selectedParent}
            options={filteredParentRelOptions}
            onchange={handleParentSelect}
            placeholder="Select a parent relationship"
            class="slds-m-bottom_large"
          ></lightning-combobox>
        </template>

        <!-- Parent Field Selector -->
        <template if:true={selectedParent}>
          <!-- Search -->
          <lightning-input
            type="search"
            placeholder="Search parent fields…"
            data-list-type="parentField"
            onchange={handleOptionsSearch}
            class="slds-m-bottom_x-small"
          ></lightning-input>
          <!-- Dual Listbox -->
          <lightning-dual-listbox
            name="parentFields"
            label="Select Parent Fields"
            source-label="Available"
            selected-label="Selected"
            options={filteredParentFieldOptions}
            value={selectedParentFields}
            onchange={handleParentFieldChange}
            class="slds-m-bottom_large"
          ></lightning-dual-listbox>
        </template>

        <!-- Child Relationships -->
        <template if:true={selectedObject}>
          <lightning-dual-listbox
            name="relatedLists"
            label="Child Relationships"
            source-label="Available"
            selected-label="Included"
            options={childRelationships}
            value={selectedRelationships}
            onchange={handleRelationshipSelection}
            class="slds-m-bottom_large"
          ></lightning-dual-listbox>
        </template>

        <!-- Child Field Selectors -->
        <template if:true={childFieldConfigs}>
          <lightning-accordion allow-multiple-sections-open>
            <template for:each={childFieldConfigs} for:item="cfg">
              <lightning-accordion-section
                key={cfg.rel}
                name={cfg.rel}
                label={cfg.rel}
              >
                <!-- Search -->
                <lightning-input
                  type="search"
                  data-list-type="child"
                  data-options-key={cfg.rel}
                  placeholder="Search fields…"
                  onchange={handleOptionsSearch}
                  class="slds-m-bottom_x-small"
                ></lightning-input>
                <!-- Dual Listbox -->
                <lightning-dual-listbox
                  name={cfg.rel}
                  source-label="Available"
                  selected-label="Selected"
                  options={cfg.options}
                  value={cfg.selected}
                  onchange={handleChildFieldSelection}
                ></lightning-dual-listbox>
              </lightning-accordion-section>
            </template>
          </lightning-accordion>
        </template>

        <!-- … rest of your template … -->

      </div>
    </lightning-card>
  </div>
</template>