<template>
  <lightning-card title="SOQL Builder">
    <div class="slds-p-around_medium">
      <!-- Object Picker -->
      <lightning-combobox
        label="Select Object"
        value={selectedObject}
        placeholder="Select Object"
        options={objectOptions}
        onchange={handleObjectChange}
      ></lightning-combobox>

      <!-- Field Selector -->
      <template if:true={dualListBoxReady}>
        <lightning-dual-listbox
          name="fieldSelector"
          label="Select Fields"
          options={fieldOptions}
          value={selectedFields}
          onchange={handleFieldSelection}
        >
        </lightning-dual-listbox>
      </template>
      <!-- Parent Selector -->
      <template if:true={hasParentOptions}>
        <lightning-combobox
          label="Parent Relationship"
          value={selectedParent}
          options={parentRelationshipOptions}
          onchange={handleParentSelect}
          placeholder="Select a parent relationship"
        >
        </lightning-combobox>
      </template>

      <template if:true={selectedParent}>
        <lightning-dual-listbox
          name="parentFields"
          label="Select Parent Fields"
          source-label="Available"
          selected-label="Selected"
          options={parentFieldOptions}
          value={selectedParentFields}
          onchange={handleParentFieldChange}
        >
        </lightning-dual-listbox>
      </template>

      <!-- Child Relationships -->
      <lightning-dual-listbox
        name="relatedLists"
        label="Child Relationships"
        source-label="Available"
        selected-label="Included"
        options={childRelationships}
        value={selectedRelationships}
        onchange={handleRelationshipSelection}
        class="slds-m-top_medium"
      ></lightning-dual-listbox>

      <!-- Child Field Selectors -->
      <template if:true={childFieldConfigs}>
        <template for:each={childFieldConfigs} for:item="cfg">
          <div key={cfg.rel} class="slds-m-vertical_small">
            <p class="slds-text-title_caps slds-m-bottom_xx-small">
              Fields for {cfg.rel}
            </p>
            <lightning-dual-listbox
              name={cfg.rel}
              source-label="Available"
              selected-label="Selected"
              options={cfg.options}
              value={cfg.selected}
              onchange={handleChildFieldSelection}
            ></lightning-dual-listbox>
          </div>
        </template>
      </template>

      <template if:true={showFieldSelector}>
        <!-- <p>showFieldSelector is true</p> -->
        <div class="slds-m-top_medium">
          <!-- WHERE Clause Section -->
          <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
            <p class="slds-text-title_bold">WHERE Clause</p>
            <lightning-button-icon
              icon-name={whereToggleIcon}
              alternative-text="Toggle Advanced Mode"
              title="Toggle WHERE Clause Mode"
              onclick={toggleWhereMode}
            ></lightning-button-icon>
          </div>

          <!-- Visual WHERE Builder -->
          <template if:false={useAdvancedMode}>
            <template for:each={filtersWithOperatorOptions} for:item="filter">
              <div
                key={filter.id}
                class="slds-grid slds-gutters slds-m-bottom_x-small"
              >
                <div class="slds-col">
                  <lightning-combobox
                    label="Field"
                    name="field"
                    data-index={filter.index}
                    value={filter.field}
                    options={fieldOptions}
                    onchange={handleFilterChange}
                  ></lightning-combobox>
                </div>
                <div class="slds-col">
                  <lightning-combobox
                    label="Operator"
                    name="operator"
                    data-index={filter.index}
                    value={filter.operator}
                    options={filter.safeOperators}
                    disabled={filter.isDisabled}
                    onchange={handleFilterChange}
                  ></lightning-combobox>
                </div>
                <div class="slds-col">
                  <lightning-input
                    label="Value"
                    name="value"
                    data-index={filter.index}
                    value={filter.value}
                    onchange={handleFilterChange}
                  ></lightning-input>
                </div>
                <div class="slds-col slds-align-middle">
                  <lightning-button-icon
                    icon-name="utility:close"
                    alternative-text="Remove Filter"
                    title="Remove Filter"
                    data-index={filter.index}
                    onclick={handleRemoveFilter}
                  ></lightning-button-icon>
                </div>
              </div>
            </template>
            <lightning-button
              class="slds-m-top_small"
              label="Add Filter"
              icon-name="utility:add"
              onclick={addFilter}
            ></lightning-button>
          </template>

          <!-- Advanced WHERE Mode -->
          <template if:true={useAdvancedMode}>
            <lightning-textarea
              label="Manual WHERE Clause"
              value={rawWhereClause}
              onchange={handleWhereInputChange}
              placeholder="e.g. Status = 'Open' AND CreatedDate > LAST_N_DAYS:30"
              class="slds-m-top_small"
            ></lightning-textarea>
          </template>
        </div>

        <!-- Build & Preview Query -->
        <lightning-button
          label="Build Query"
          title="Build SOQL Query"
          onclick={handleBuildQuery}
          class="slds-m-top_medium"
        ></lightning-button>

        <template if:true={soqlPreview}>
          <lightning-card title="SOQL Preview">
            <pre class="soql-preview">{soqlPreview}</pre>
          </lightning-card>
        </template>

        <template if:false={soqlPreview}>
          <!-- Only show hint if user hasn't built anything -->
          <template if:false={queryResults}>
            <p class="soql-placeholder">
              ðŸ‘‹ Select an object and fields to begin building your queryâ€¦
            </p>
          </template>
        </template>

        <!-- Query Results Table -->
        <template if:true={queryResults}>
          <lightning-card title="Query Results" class="slds-m-top_medium">
            <lightning-datatable
              key-field="Id"
              data={queryResults}
              columns={tableColumns}
            ></lightning-datatable>
            <lightning-button
              label="Email CSV Results"
              onclick={handleExport}
              variant="brand"
              class="slds-m-top_medium"
            ></lightning-button>
          </lightning-card>
        </template>
      </template>
    </div>
  </lightning-card>
</template>
